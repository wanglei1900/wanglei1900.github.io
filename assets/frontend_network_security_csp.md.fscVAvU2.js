import{_ as d,C as k,c as o,o as t,a7 as l,b as p,j as a,w as n,a as i,G as r,a8 as h}from"./chunks/framework.Dtft01Yp.js";const C=JSON.parse('{"title":"内容安全策略 (CSP) 学习笔记","description":"","frontmatter":{},"headers":[],"relativePath":"frontend/network/security/csp.md","filePath":"frontend/network/security/csp.md","lastUpdated":1752498754000}'),c={name:"frontend/network/security/csp.md"};function E(g,s,u,b,y,m){const e=k("Mermaid");return t(),o("div",null,[s[2]||(s[2]=l('<h1 id="内容安全策略-csp-学习笔记" tabindex="-1">内容安全策略 (CSP) 学习笔记 <a class="header-anchor" href="#内容安全策略-csp-学习笔记" aria-label="Permalink to &quot;内容安全策略 (CSP) 学习笔记&quot;">​</a></h1><h2 id="csp-核心概念" tabindex="-1">CSP 核心概念 <a class="header-anchor" href="#csp-核心概念" aria-label="Permalink to &quot;CSP 核心概念&quot;">​</a></h2><h3 id="什么是-csp" tabindex="-1">什么是 CSP？ <a class="header-anchor" href="#什么是-csp" aria-label="Permalink to &quot;什么是 CSP？&quot;">​</a></h3><p>内容安全策略（Content Security Policy）是一种<strong>安全增强层</strong>，通过声明式策略限制网页可以加载哪些资源，从而有效减少跨站脚本攻击（XSS）、点击劫持和数据注入攻击的风险。</p><h3 id="为什么需要-csp" tabindex="-1">为什么需要 CSP？ <a class="header-anchor" href="#为什么需要-csp" aria-label="Permalink to &quot;为什么需要 CSP？&quot;">​</a></h3><ul><li><strong>XSS 防护</strong>：阻止未经授权的脚本执行</li><li><strong>数据泄露防护</strong>：限制外部资源加载</li><li><strong>混合内容防护</strong>：阻止 HTTP 资源在 HTTPS 页面加载</li><li><strong>报告机制</strong>：监控潜在的安全威胁</li></ul><h3 id="csp-工作原理" tabindex="-1">CSP 工作原理 <a class="header-anchor" href="#csp-工作原理" aria-label="Permalink to &quot;CSP 工作原理&quot;">​</a></h3>',7)),(t(),p(h,null,{default:n(()=>[r(e,{id:"mermaid-40",class:"mermaid",graph:"graph%20LR%0A%20%20A%5B%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8A%A0%E8%BD%BD%E9%A1%B5%E9%9D%A2%5D%20--%3E%20B%5B%E8%A7%A3%E6%9E%90%20CSP%20%E7%AD%96%E7%95%A5%5D%0A%20%20B%20--%3E%20C%7B%E8%B5%84%E6%BA%90%E8%AF%B7%E6%B1%82%7D%0A%20%20C%20--%3E%7C%E7%AC%A6%E5%90%88%E7%AD%96%E7%95%A5%7C%20D%5B%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%5D%0A%20%20C%20--%3E%7C%E8%BF%9D%E5%8F%8D%E7%AD%96%E7%95%A5%7C%20E%5B%E9%98%BB%E6%AD%A2%E5%8A%A0%E8%BD%BD%5D%0A%20%20E%20--%3E%20F%5B%E5%8F%91%E9%80%81%E8%BF%9D%E8%A7%84%E6%8A%A5%E5%91%8A%5D%0A"})]),fallback:n(()=>s[0]||(s[0]=[i(" Loading... ")])),_:1})),s[3]||(s[3]=l(`<h2 id="csp-指令详解" tabindex="-1">CSP 指令详解 <a class="header-anchor" href="#csp-指令详解" aria-label="Permalink to &quot;CSP 指令详解&quot;">​</a></h2><h3 id="资源加载指令" tabindex="-1">资源加载指令 <a class="header-anchor" href="#资源加载指令" aria-label="Permalink to &quot;资源加载指令&quot;">​</a></h3><table tabindex="0"><thead><tr><th>指令</th><th>功能</th><th>示例</th></tr></thead><tbody><tr><td><strong>default-src</strong></td><td>所有资源的默认策略</td><td><code>default-src &#39;self&#39;</code></td></tr><tr><td><strong>script-src</strong></td><td>控制 JavaScript 加载</td><td><code>script-src &#39;self&#39; cdn.example.com</code></td></tr><tr><td><strong>style-src</strong></td><td>控制 CSS 加载</td><td><code>style-src &#39;self&#39; fonts.googleapis.com</code></td></tr><tr><td><strong>img-src</strong></td><td>控制图片加载</td><td><code>img-src * data:</code></td></tr><tr><td><strong>font-src</strong></td><td>控制字体加载</td><td><code>font-src &#39;self&#39; fonts.gstatic.com</code></td></tr><tr><td><strong>media-src</strong></td><td>控制媒体文件加载</td><td><code>media-src &#39;self&#39;</code></td></tr><tr><td><strong>connect-src</strong></td><td>控制 XHR、WebSocket 等连接</td><td><code>connect-src https://api.example.com</code></td></tr><tr><td><strong>frame-src</strong></td><td>控制 iframe 嵌入</td><td><code>frame-src &#39;self&#39; youtube.com</code></td></tr><tr><td><strong>object-src</strong></td><td>控制 <code>&lt;object&gt;</code>、<code>&lt;embed&gt;</code> 等插件</td><td><code>object-src &#39;none&#39;</code></td></tr></tbody></table><h3 id="文档指令" tabindex="-1">文档指令 <a class="header-anchor" href="#文档指令" aria-label="Permalink to &quot;文档指令&quot;">​</a></h3><table tabindex="0"><thead><tr><th>指令</th><th>功能</th><th>示例</th></tr></thead><tbody><tr><td><strong>base-uri</strong></td><td>限制 <code>&lt;base&gt;</code> 标签的 URL</td><td><code>base-uri &#39;self&#39;</code></td></tr><tr><td><strong>form-action</strong></td><td>限制表单提交目标</td><td><code>form-action &#39;self&#39; payment.example.com</code></td></tr><tr><td><strong>frame-ancestors</strong></td><td>限制页面嵌入（替代 X-Frame-Options）</td><td><code>frame-ancestors &#39;none&#39;</code></td></tr></tbody></table><h3 id="其他关键指令" tabindex="-1">其他关键指令 <a class="header-anchor" href="#其他关键指令" aria-label="Permalink to &quot;其他关键指令&quot;">​</a></h3><table tabindex="0"><thead><tr><th>指令</th><th>功能</th><th>示例</th></tr></thead><tbody><tr><td><strong>report-uri</strong></td><td>指定违规报告地址（已弃用）</td><td><code>report-uri /csp-report</code></td></tr><tr><td><strong>report-to</strong></td><td>指定违规报告端点（新标准）</td><td><code>report-to csp-endpoint</code></td></tr><tr><td><strong>upgrade-insecure-requests</strong></td><td>自动升级 HTTP 资源到 HTTPS</td><td><code>upgrade-insecure-requests</code></td></tr><tr><td><strong>sandbox</strong></td><td>启用沙盒环境</td><td><code>sandbox allow-forms</code></td></tr></tbody></table><h2 id="csp-策略语法" tabindex="-1">CSP 策略语法 <a class="header-anchor" href="#csp-策略语法" aria-label="Permalink to &quot;CSP 策略语法&quot;">​</a></h2><h3 id="源表达式" tabindex="-1">源表达式 <a class="header-anchor" href="#源表达式" aria-label="Permalink to &quot;源表达式&quot;">​</a></h3><table tabindex="0"><thead><tr><th>表达式</th><th>含义</th></tr></thead><tbody><tr><td><code>&#39;none&#39;</code></td><td>禁止任何来源</td></tr><tr><td><code>&#39;self&#39;</code></td><td>仅允许同源资源</td></tr><tr><td><code>&#39;unsafe-inline&#39;</code></td><td>允许内联资源（慎用）</td></tr><tr><td><code>&#39;unsafe-eval&#39;</code></td><td>允许 eval() 等动态代码（慎用）</td></tr><tr><td><code>data:</code></td><td>允许 data URL</td></tr><tr><td><code>https:</code></td><td>允许所有 HTTPS 资源</td></tr><tr><td><code>*.example.com</code></td><td>允许 example.com 的所有子域</td></tr><tr><td><code>https://cdn.example.com</code></td><td>允许特定域</td></tr></tbody></table><h3 id="哈希与随机数" tabindex="-1">哈希与随机数 <a class="header-anchor" href="#哈希与随机数" aria-label="Permalink to &quot;哈希与随机数&quot;">​</a></h3><div class="language-html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- 内联脚本使用哈希 --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 脚本内容</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>策略: <code>script-src &#39;sha256-abc123...&#39;</code></p><div class="language-html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- 内联脚本使用随机数 --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> nonce</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;rAnd0m123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 脚本内容</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>策略: <code>script-src &#39;nonce-rAnd0m123&#39;</code></p><h3 id="完整策略示例" tabindex="-1">完整策略示例 <a class="header-anchor" href="#完整策略示例" aria-label="Permalink to &quot;完整策略示例&quot;">​</a></h3><div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Security-Policy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  default-src &#39;self&#39;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  script-src &#39;self&#39; &#39;sha256-abc123&#39; https://apis.google.com;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  style-src &#39;self&#39; &#39;unsafe-inline&#39;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  img-src * data:;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  font-src fonts.gstatic.com;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  connect-src https://api.example.com;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  frame-src youtube.com;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  report-uri /csp-report-endpoint;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  upgrade-insecure-requests;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="csp-部署策略" tabindex="-1">CSP 部署策略 <a class="header-anchor" href="#csp-部署策略" aria-label="Permalink to &quot;CSP 部署策略&quot;">​</a></h2><h3 id="实施步骤" tabindex="-1">实施步骤 <a class="header-anchor" href="#实施步骤" aria-label="Permalink to &quot;实施步骤&quot;">​</a></h3><ol><li><strong>审计现有资源</strong>：分析页面加载的所有资源</li><li><strong>创建初始策略</strong>：使用 <code>Content-Security-Policy-Report-Only</code></li><li><strong>收集违规报告</strong>：监控报告端点</li><li><strong>迭代优化策略</strong>：根据报告调整策略</li><li><strong>强制执行</strong>：切换到 <code>Content-Security-Policy</code></li></ol><h3 id="http-头部署" tabindex="-1">HTTP 头部署 <a class="header-anchor" href="#http-头部署" aria-label="Permalink to &quot;HTTP 头部署&quot;">​</a></h3><div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 强制执行模式</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Security-Policy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default-src &#39;self&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 报告模式（不强制执行）</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Security-Policy-Report-Only</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default-src &#39;self&#39;; report-uri /csp-report</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="html-meta-标签部署" tabindex="-1">HTML Meta 标签部署 <a class="header-anchor" href="#html-meta-标签部署" aria-label="Permalink to &quot;HTML Meta 标签部署&quot;">​</a></h3><div class="language-html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">meta</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> http-equiv</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Content-Security-Policy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      content</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;default-src &#39;self&#39;; img-src https://*; child-src &#39;none&#39;;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="违规报告机制" tabindex="-1">违规报告机制 <a class="header-anchor" href="#违规报告机制" aria-label="Permalink to &quot;违规报告机制&quot;">​</a></h2><h3 id="报告格式示例" tabindex="-1">报告格式示例 <a class="header-anchor" href="#报告格式示例" aria-label="Permalink to &quot;报告格式示例&quot;">​</a></h3><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;csp-report&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;document-uri&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://example.com/page&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;referrer&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://google.com/&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;blocked-uri&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;http://malicious.com/script.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;violated-directive&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;script-src&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;effective-directive&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;script-src&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;original-policy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;default-src &#39;self&#39;; script-src &#39;self&#39;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;status-code&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;source-file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://example.com/page&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;line-number&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;column-number&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="现代报告-api-report-to" tabindex="-1">现代报告 API (Report-To) <a class="header-anchor" href="#现代报告-api-report-to" aria-label="Permalink to &quot;现代报告 API (Report-To)&quot;">​</a></h3><div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Report-To</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &quot;group&quot;: &quot;csp-endpoint&quot;,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &quot;max_age&quot;: 10886400,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &quot;endpoints&quot;: [{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://example.com/csp-reports&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Content-Security-Policy: default-src &#39;self&#39;; report-to csp-endpoint</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="csp-最佳实践" tabindex="-1">CSP 最佳实践 <a class="header-anchor" href="#csp-最佳实践" aria-label="Permalink to &quot;CSP 最佳实践&quot;">​</a></h2><h3 id="安全策略推荐" tabindex="-1">安全策略推荐 <a class="header-anchor" href="#安全策略推荐" aria-label="Permalink to &quot;安全策略推荐&quot;">​</a></h3><div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 严格策略示例</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Security-Policy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  default-src &#39;none&#39;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  script-src &#39;self&#39; &#39;nonce-random123&#39; https://trusted.cdn.com;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  style-src &#39;self&#39; &#39;sha256-abc...&#39;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  img-src &#39;self&#39; data:;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  font-src &#39;self&#39;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  connect-src &#39;self&#39; https://api.example.com;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  form-action &#39;self&#39;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  frame-ancestors &#39;none&#39;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  base-uri &#39;self&#39;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  report-uri /csp-report;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  upgrade-insecure-requests;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="渐进式策略" tabindex="-1">渐进式策略 <a class="header-anchor" href="#渐进式策略" aria-label="Permalink to &quot;渐进式策略&quot;">​</a></h3><ol><li>从报告模式开始</li><li>逐步限制资源来源</li><li>消除 <code>&#39;unsafe-inline&#39;</code></li><li>消除 <code>&#39;unsafe-eval&#39;</code></li><li>限制第三方域</li><li>添加随机数或哈希</li></ol><h3 id="常见问题解决方案" tabindex="-1">常见问题解决方案 <a class="header-anchor" href="#常见问题解决方案" aria-label="Permalink to &quot;常见问题解决方案&quot;">​</a></h3><table tabindex="0"><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>内联脚本被阻止</strong></td><td>使用随机数或哈希替代 <code>&#39;unsafe-inline&#39;</code></td></tr><tr><td><strong>动态代码执行失败</strong></td><td>重构代码避免 <code>eval()</code>，或使用 <code>&#39;unsafe-eval&#39;</code>（临时方案）</td></tr><tr><td><strong>CDN 资源被阻止</strong></td><td>明确添加 CDN 到相应指令：<code>script-src https://cdn.example.com</code></td></tr><tr><td><strong>混合内容问题</strong></td><td>添加 <code>upgrade-insecure-requests</code> 或修复资源 URL</td></tr><tr><td><strong>缺少资源类型</strong></td><td>添加特定指令如 <code>font-src</code> 或 <code>media-src</code></td></tr></tbody></table><h2 id="csp-与框架集成" tabindex="-1">CSP 与框架集成 <a class="header-anchor" href="#csp-与框架集成" aria-label="Permalink to &quot;CSP 与框架集成&quot;">​</a></h2><h3 id="react-应用-csp" tabindex="-1">React 应用 CSP <a class="header-anchor" href="#react-应用-csp" aria-label="Permalink to &quot;React 应用 CSP&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 生成随机数并注入</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nonce</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> generateNonce</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 服务器渲染</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setHeader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Content-Security-Policy&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`script-src &#39;nonce-\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">nonce</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&#39;\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 客户端使用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> nonce</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{nonce} </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">src</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/bundle.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="angular-应用-csp" tabindex="-1">Angular 应用 CSP <a class="header-anchor" href="#angular-应用-csp" aria-label="Permalink to &quot;Angular 应用 CSP&quot;">​</a></h3><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 在 angular.json 中配置 CSP</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;projects&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;my-app&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;architect&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;build&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;options&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          &quot;csp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;default-src &#39;self&#39;; script-src &#39;self&#39; &#39;unsafe-inline&#39;;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="vue-cli-应用-csp" tabindex="-1">Vue CLI 应用 CSP <a class="header-anchor" href="#vue-cli-应用-csp" aria-label="Permalink to &quot;Vue CLI 应用 CSP&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// vue.config.js</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exports</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  devServer: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    headers: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;Content-Security-Policy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;default-src &#39;self&#39;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="csp-安全加固" tabindex="-1">CSP 安全加固 <a class="header-anchor" href="#csp-安全加固" aria-label="Permalink to &quot;CSP 安全加固&quot;">​</a></h2><h3 id="高级防护技术" tabindex="-1">高级防护技术 <a class="header-anchor" href="#高级防护技术" aria-label="Permalink to &quot;高级防护技术&quot;">​</a></h3><ol><li><p><strong>严格动态</strong>：<code>script-src &#39;strict-dynamic&#39;</code></p><ul><li>信任由已授权脚本加载的脚本</li></ul></li><li><p><strong>信任类型</strong>：<code>require-trusted-types-for &#39;script&#39;</code></p><ul><li>强制使用安全API处理危险操作</li></ul></li><li><p><strong>可信类型策略</strong>：</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 创建可信类型策略</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> policy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trustedTypes.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;escapePolicy&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  createHTML</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">input</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sanitize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 使用策略</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">element.innerHTML </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> policy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createHTML</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(untrustedInput);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ol><h3 id="沙盒化策略" tabindex="-1">沙盒化策略 <a class="header-anchor" href="#沙盒化策略" aria-label="Permalink to &quot;沙盒化策略&quot;">​</a></h3><div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Security-Policy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sandbox allow-same-origin allow-scripts</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>允许的权限：</p><ul><li><code>allow-forms</code>：允许表单提交</li><li><code>allow-modals</code>：允许弹窗</li><li><code>allow-orientation-lock</code>：允许屏幕方向锁定</li><li><code>allow-pointer-lock</code>：允许指针锁定</li><li><code>allow-popups</code>：允许弹出窗口</li><li><code>allow-same-origin</code>：允许同源访问</li><li><code>allow-scripts</code>：允许脚本执行</li><li><code>allow-top-navigation</code>：允许顶级导航</li></ul><h2 id="csp-测试与验证" tabindex="-1">CSP 测试与验证 <a class="header-anchor" href="#csp-测试与验证" aria-label="Permalink to &quot;CSP 测试与验证&quot;">​</a></h2><h3 id="开发工具使用" tabindex="-1">开发工具使用 <a class="header-anchor" href="#开发工具使用" aria-label="Permalink to &quot;开发工具使用&quot;">​</a></h3><ol><li><strong>浏览器控制台</strong>：查看 CSP 违规警告</li><li><strong>Network 面板</strong>：检查 CSP 头部</li><li><strong>Security 面板</strong>：查看完整策略和违规</li></ol><h3 id="在线验证工具" tabindex="-1">在线验证工具 <a class="header-anchor" href="#在线验证工具" aria-label="Permalink to &quot;在线验证工具&quot;">​</a></h3><ol><li><a href="https://csp-evaluator.withgoogle.com/" target="_blank" rel="noreferrer">CSP Evaluator</a> - Google 的 CSP 策略评估器</li><li><a href="https://securityheaders.com/" target="_blank" rel="noreferrer">Security Headers</a> - 安全头部检查</li><li><a href="https://report-uri.com/" target="_blank" rel="noreferrer">Report URI</a> - 专业报告服务</li></ol><h3 id="自动化测试" tabindex="-1">自动化测试 <a class="header-anchor" href="#自动化测试" aria-label="Permalink to &quot;自动化测试&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Puppeteer 测试 CSP</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> puppeteer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;puppeteer&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> browser</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> puppeteer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">launch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> page</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> browser.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newPage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 监听 CSP 违规</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  page.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;console&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">msg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (msg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;error&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;CSP&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;CSP Violation:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, msg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> page.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">goto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://example.com&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> browser.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="csp-未来趋势" tabindex="-1">CSP 未来趋势 <a class="header-anchor" href="#csp-未来趋势" aria-label="Permalink to &quot;CSP 未来趋势&quot;">​</a></h2><h3 id="新规范特性" tabindex="-1">新规范特性 <a class="header-anchor" href="#新规范特性" aria-label="Permalink to &quot;新规范特性&quot;">​</a></h3><ol><li><strong>Worker 控制</strong>：<code>worker-src</code> 指令</li><li><strong>预取控制</strong>：<code>prefetch-src</code> 指令</li><li><strong>导航控制</strong>：<code>navigate-to</code> 指令</li><li><strong>WebAssembly 控制</strong>：<code>wasm-unsafe-eval</code> 指令</li></ol><h3 id="安全增强方向" tabindex="-1">安全增强方向 <a class="header-anchor" href="#安全增强方向" aria-label="Permalink to &quot;安全增强方向&quot;">​</a></h3><ol><li><strong>基于签名的资源验证</strong>：<code>script-src &#39;signature-algorithm=...&#39;</code></li><li><strong>更细粒度的内联控制</strong>：替代 <code>&#39;unsafe-inline&#39;</code></li><li><strong>AI 驱动的策略生成</strong>：自动优化 CSP 规则</li><li><strong>框架深度集成</strong>：框架自动生成安全策略</li></ol>`,62)),(t(),p(h,null,{default:n(()=>[r(e,{id:"mermaid-732",class:"mermaid",graph:"graph%20TD%0A%20%20A%5B%E5%BD%93%E5%89%8D%20CSP%5D%20--%3E%20B%5B%E6%B6%88%E9%99%A4%20XSS%5D%0A%20%20A%20--%3E%20C%5B%E9%99%90%E5%88%B6%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%5D%0A%20%20D%5B%E6%9C%AA%E6%9D%A5%20CSP%5D%20--%3E%20E%5BAPI%20%E7%BA%A7%E6%8E%A7%E5%88%B6%5D%0A%20%20D%20--%3E%20F%5B%E8%87%AA%E5%8A%A8%E7%AD%96%E7%95%A5%E4%BC%98%E5%8C%96%5D%0A%20%20D%20--%3E%20G%5B%E5%9F%BA%E4%BA%8E%E8%A1%8C%E4%B8%BA%E7%9A%84%E7%AD%96%E7%95%A5%5D%0A%20%20B%20--%3E%20D%0A%20%20C%20--%3E%20D%0A"})]),fallback:n(()=>s[1]||(s[1]=[i(" Loading... ")])),_:1})),s[4]||(s[4]=a("blockquote",null,[a("p",null,[a("strong",null,"最佳实践总结"),i("：CSP 不是一次性配置，而是一个持续优化的过程。从报告模式开始，逐步收紧策略，消除 "),a("code",null,"'unsafe-inline'"),i(" 和 "),a("code",null,"'unsafe-eval'"),i("，使用随机数和哈希替代内联资源。结合现代浏览器特性如可信类型和严格动态，实现深度防御。监控违规报告，定期审计策略，将 CSP 作为 Web 应用安全的核心组成部分而非附加功能。")])],-1))])}const A=d(c,[["render",E]]);export{C as __pageData,A as default};
