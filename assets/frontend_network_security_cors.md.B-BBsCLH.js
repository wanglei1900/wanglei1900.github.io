import{_ as e,C as l,c as r,o as i,a7 as a,b as h,w as n,a as p,G as d,a8 as o}from"./chunks/framework.Dtft01Yp.js";const A=JSON.parse('{"title":"CORS机制详解：跨域资源共享完整指南","description":"","frontmatter":{},"headers":[],"relativePath":"frontend/network/security/cors.md","filePath":"frontend/network/security/cors.md","lastUpdated":1752498754000}'),k={name:"frontend/network/security/cors.md"};function c(E,s,g,b,u,F){const t=l("Mermaid");return i(),r("div",null,[s[1]||(s[1]=a('<h1 id="cors机制详解-跨域资源共享完整指南" tabindex="-1">CORS机制详解：跨域资源共享完整指南 <a class="header-anchor" href="#cors机制详解-跨域资源共享完整指南" aria-label="Permalink to &quot;CORS机制详解：跨域资源共享完整指南&quot;">​</a></h1><h2 id="一、同源策略与跨域问题" tabindex="-1">一、同源策略与跨域问题 <a class="header-anchor" href="#一、同源策略与跨域问题" aria-label="Permalink to &quot;一、同源策略与跨域问题&quot;">​</a></h2><h3 id="_1-1-同源策略-sop" tabindex="-1">1.1 同源策略（SOP） <a class="header-anchor" href="#_1-1-同源策略-sop" aria-label="Permalink to &quot;1.1 同源策略（SOP）&quot;">​</a></h3><ul><li><strong>定义</strong>：浏览器核心安全机制，限制<strong>不同源</strong>的文档/脚本间资源交互</li><li><strong>同源判定标准</strong>：协议+域名+端口<strong>完全一致</strong></li><li><strong>限制范围</strong>： <ul><li>AJAX/Fetch请求</li><li>DOM访问（iframe跨域）</li><li>Cookie/LocalStorage读取</li></ul></li><li><strong>安全意义</strong>：防止恶意网站窃取数据（如CSRF攻击）</li></ul><h3 id="_1-2-跨域场景示例" tabindex="-1">1.2 跨域场景示例 <a class="header-anchor" href="#_1-2-跨域场景示例" aria-label="Permalink to &quot;1.2 跨域场景示例&quot;">​</a></h3><table tabindex="0"><thead><tr><th><strong>请求来源</strong></th><th><strong>目标URL</strong></th><th><strong>是否跨域</strong></th><th><strong>原因</strong></th></tr></thead><tbody><tr><td><code>http://a.com</code></td><td><code>http://a.com/api</code></td><td>否</td><td>同源</td></tr><tr><td><code>https://a.com</code></td><td><code>http://a.com</code></td><td>是</td><td>协议不同</td></tr><tr><td><code>http://a.com:80</code></td><td><code>http://a.com:8080</code></td><td>是</td><td>端口不同</td></tr><tr><td><code>http://a.com</code></td><td><code>http://api.a.com</code></td><td>是</td><td>子域名不同</td></tr></tbody></table><h2 id="二、cors核心机制" tabindex="-1">二、CORS核心机制 <a class="header-anchor" href="#二、cors核心机制" aria-label="Permalink to &quot;二、CORS核心机制&quot;">​</a></h2><h3 id="_2-1-基本概念" tabindex="-1">2.1 基本概念 <a class="header-anchor" href="#_2-1-基本概念" aria-label="Permalink to &quot;2.1 基本概念&quot;">​</a></h3><ul><li><strong>定义</strong>：W3C标准，允许浏览器向<strong>跨源服务器</strong>发送XMLHttpRequest/Fetch请求</li><li><strong>核心组件</strong>： <ul><li><strong>HTTP头部协商</strong>：通过特定Header声明资源访问权限</li><li><strong>浏览器代理</strong>：自动处理协商过程，对开发者透明</li><li><strong>服务器控制</strong>：响应头决定是否允许跨域访问</li></ul></li></ul><h3 id="_2-2-工作原理" tabindex="-1">2.2 工作原理 <a class="header-anchor" href="#_2-2-工作原理" aria-label="Permalink to &quot;2.2 工作原理&quot;">​</a></h3>',10)),(i(),h(o,null,{default:n(()=>[d(t,{id:"mermaid-165",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20Client%20as%20%E5%AE%A2%E6%88%B7%E7%AB%AF%0A%20%20%20%20participant%20Browser%20as%20%E6%B5%8F%E8%A7%88%E5%99%A8%0A%20%20%20%20participant%20Server%20as%20%E7%9B%AE%E6%A0%87%E6%9C%8D%E5%8A%A1%E5%99%A8%0A%0A%20%20%20%20Client-%3E%3EBrowser%3A%20%E5%8F%91%E8%B5%B7%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82%0A%20%20%20%20Browser-%3E%3EServer%3A%20%E8%87%AA%E5%8A%A8%E6%B7%BB%E5%8A%A0Origin%E5%A4%B4%0A%20%20%20%20alt%20%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82%0A%20%20%20%20%20%20%20%20Server--%3E%3EBrowser%3A%20%E8%BF%94%E5%9B%9ECORS%E5%93%8D%E5%BA%94%E5%A4%B4%0A%20%20%20%20%20%20%20%20Browser--%3E%3EClient%3A%20%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94%E6%95%B0%E6%8D%AE%0A%20%20%20%20else%20%E9%9D%9E%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82%0A%20%20%20%20%20%20%20%20Browser-%3E%3EServer%3A%20%E5%8F%91%E9%80%81OPTIONS%E9%A2%84%E6%A3%80%E8%AF%B7%E6%B1%82%0A%20%20%20%20%20%20%20%20Server--%3E%3EBrowser%3A%20%E8%BF%94%E5%9B%9E%E9%A2%84%E6%A3%80%E5%93%8D%E5%BA%94%E5%A4%B4%0A%20%20%20%20%20%20%20%20Browser-%3E%3EServer%3A%20%E5%8F%91%E9%80%81%E5%AE%9E%E9%99%85%E8%AF%B7%E6%B1%82%0A%20%20%20%20%20%20%20%20Server--%3E%3EBrowser%3A%20%E8%BF%94%E5%9B%9E%E5%AE%9E%E9%99%85%E5%93%8D%E5%BA%94%0A%20%20%20%20%20%20%20%20Browser--%3E%3EClient%3A%20%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94%E6%95%B0%E6%8D%AE%0A%20%20%20%20end%0A"})]),fallback:n(()=>s[0]||(s[0]=[p(" Loading... ")])),_:1})),s[2]||(s[2]=a(`<h2 id="三、请求类型详解" tabindex="-1">三、请求类型详解 <a class="header-anchor" href="#三、请求类型详解" aria-label="Permalink to &quot;三、请求类型详解&quot;">​</a></h2><h3 id="_3-1-简单请求" tabindex="-1">3.1 简单请求 <a class="header-anchor" href="#_3-1-简单请求" aria-label="Permalink to &quot;3.1 简单请求&quot;">​</a></h3><p><strong>判定条件（同时满足）</strong>：</p><ol><li>请求方法为：<code>GET</code>/<code>HEAD</code>/<code>POST</code></li><li>仅包含以下Header： <ul><li><code>Accept</code></li><li><code>Accept-Language</code></li><li><code>Content-Language</code></li><li><code>Content-Type</code>（值限于<code>text/plain</code>/<code>multipart/form-data</code>/<code>application/x-www-form-urlencoded</code>）</li></ul></li></ol><p><strong>通信流程</strong>：</p><ol><li>浏览器自动添加<code>Origin: https://your-site.com</code></li><li>服务器响应需包含：<div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Allow-Origin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://your-site.com  // 或 *</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Allow-Credentials</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> true              // 可选</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Expose-Headers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> X-Custom-Header     // 可选</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li>浏览器验证<code>Access-Control-Allow-Origin</code>匹配后放行响应</li></ol><h3 id="_3-2-预检请求-非简单请求" tabindex="-1">3.2 预检请求（非简单请求） <a class="header-anchor" href="#_3-2-预检请求-非简单请求" aria-label="Permalink to &quot;3.2 预检请求（非简单请求）&quot;">​</a></h3><p><strong>触发条件（任一）</strong>：</p><ul><li>请求方法为<code>PUT</code>/<code>DELETE</code>/<code>PATCH</code>等</li><li>包含自定义Header（如<code>Authorization</code>）</li><li><code>Content-Type</code>为<code>application/json</code></li></ul><p><strong>预检阶段</strong>：</p><div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">OPTIONS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /resource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HTTP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Origin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://your-site.com</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Request-Method</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DELETE</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Request-Headers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Authorization,Content-Type</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>服务器响应</strong>：</p><div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HTTP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 204</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> No Content</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Allow-Origin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://your-site.com</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Allow-Methods</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GET,POST,DELETE</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Allow-Headers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Authorization,Content-Type</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Max-Age</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 86400       // 预检缓存时间(秒)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>后续流程</strong>：浏览器收到有效预检响应后发送实际请求</p><h2 id="四、关键http头部详解" tabindex="-1">四、关键HTTP头部详解 <a class="header-anchor" href="#四、关键http头部详解" aria-label="Permalink to &quot;四、关键HTTP头部详解&quot;">​</a></h2><h3 id="_4-1-请求头" tabindex="-1">4.1 请求头 <a class="header-anchor" href="#_4-1-请求头" aria-label="Permalink to &quot;4.1 请求头&quot;">​</a></h3><table tabindex="0"><thead><tr><th><strong>Header名称</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td><code>Origin</code></td><td>请求来源（协议+域名+端口）</td><td><code>Origin: https://front.com:8080</code></td></tr><tr><td><code>Access-Control-Request-Method</code></td><td>预检请求中声明实际方法</td><td><code>Access-Control-Request-Method: PUT</code></td></tr><tr><td><code>Access-Control-Request-Headers</code></td><td>预检请求中声明自定义头</td><td><code>Access-Control-Request-Headers: X-Auth-Token</code></td></tr></tbody></table><h3 id="_4-2-响应头" tabindex="-1">4.2 响应头 <a class="header-anchor" href="#_4-2-响应头" aria-label="Permalink to &quot;4.2 响应头&quot;">​</a></h3><table tabindex="0"><thead><tr><th><strong>Header名称</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td><code>Access-Control-Allow-Origin</code></td><td><strong>必需</strong>，允许访问的源</td><td><code>Access-Control-Allow-Origin: *</code> 或具体域名</td></tr><tr><td><code>Access-Control-Allow-Methods</code></td><td>允许的HTTP方法</td><td><code>Access-Control-Allow-Methods: GET,POST,PUT</code></td></tr><tr><td><code>Access-Control-Allow-Headers</code></td><td>允许的自定义头</td><td><code>Access-Control-Allow-Headers: X-Requested-With</code></td></tr><tr><td><code>Access-Control-Allow-Credentials</code></td><td>是否允许发送凭证</td><td><code>Access-Control-Allow-Credentials: true</code></td></tr><tr><td><code>Access-Control-Expose-Headers</code></td><td>暴露给前端的额外响应头</td><td><code>Access-Control-Expose-Headers: X-Total-Count</code></td></tr><tr><td><code>Access-Control-Max-Age</code></td><td>预检结果缓存时间</td><td><code>Access-Control-Max-Age: 3600</code></td></tr></tbody></table><h2 id="五、凭证与cookie处理" tabindex="-1">五、凭证与Cookie处理 <a class="header-anchor" href="#五、凭证与cookie处理" aria-label="Permalink to &quot;五、凭证与Cookie处理&quot;">​</a></h2><h3 id="_5-1-启用凭证传递" tabindex="-1">5.1 启用凭证传递 <a class="header-anchor" href="#_5-1-启用凭证传递" aria-label="Permalink to &quot;5.1 启用凭证传递&quot;">​</a></h3><p><strong>客户端</strong>：</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// XMLHttpRequest</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> xhr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> XMLHttpRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xhr.withCredentials </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Fetch API</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  credentials: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;include&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>服务端</strong>：</p><div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Allow-Credentials</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Allow-Origin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://your-site.com  // 不能为*</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_5-2-安全限制" tabindex="-1">5.2 安全限制 <a class="header-anchor" href="#_5-2-安全限制" aria-label="Permalink to &quot;5.2 安全限制&quot;">​</a></h3><ul><li><strong>同源Cookie策略</strong>：仅发送<strong>目标服务器域名</strong>下的Cookie</li><li><strong>Header可见性</strong>：默认仅暴露6个基础头，需通过<code>Access-Control-Expose-Headers</code>扩展</li><li><strong>CSRF防护</strong>：仍需配合Token验证等机制</li></ul><h2 id="六、服务端配置示例" tabindex="-1">六、服务端配置示例 <a class="header-anchor" href="#六、服务端配置示例" aria-label="Permalink to &quot;六、服务端配置示例&quot;">​</a></h2><h3 id="_6-1-node-js-express" tabindex="-1">6.1 Node.js/Express <a class="header-anchor" href="#_6-1-node-js-express" aria-label="Permalink to &quot;6.1 Node.js/Express&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> allowedOrigins</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://safe-site.com&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://localhost:3000&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> origin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.headers.origin;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (allowedOrigins.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(origin)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setHeader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Access-Control-Allow-Origin&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, origin);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Access-Control-Allow-Methods&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;GET,PUT,POST,DELETE&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Access-Control-Allow-Headers&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Content-Type,Authorization&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Access-Control-Allow-Credentials&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;true&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Access-Control-Max-Age&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;86400&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 处理预检请求</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (req.method </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;OPTIONS&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sendStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_6-2-nginx配置" tabindex="-1">6.2 Nginx配置 <a class="header-anchor" href="#_6-2-nginx配置" aria-label="Permalink to &quot;6.2 Nginx配置&quot;">​</a></h3><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> /api/ </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($http_origin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~* </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(https?://(localhost|safe-site\\.com))) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      add_header </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Access-Control-Allow-Origin&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http_origin</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      add_header </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Access-Control-Allow-Credentials&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;true&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      add_header </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Access-Control-Allow-Methods&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;GET,POST,OPTIONS&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      add_header </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Access-Control-Allow-Headers&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;DNT,Authorization,Content-Type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 预检请求直接响应</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($request_method </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">= </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;OPTIONS&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 204</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://backend;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="七、安全最佳实践" tabindex="-1">七、安全最佳实践 <a class="header-anchor" href="#七、安全最佳实践" aria-label="Permalink to &quot;七、安全最佳实践&quot;">​</a></h2><ol><li><strong>避免使用<code>*</code>通配符</strong>：明确指定可信域名白名单<div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 不安全配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Allow-Origin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> *</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 安全配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Allow-Origin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://trusted-domain.com</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><strong>严格限制HTTP方法</strong>：按需开放<code>Allow-Methods</code><div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 风险配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Allow-Methods</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> *</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 安全配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Access-Control-Allow-Methods</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GET,POST</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><strong>凭证传输最小化</strong>：非必要场景关闭<code>Allow-Credentials</code></li><li><strong>预检请求缓存优化</strong>：合理设置<code>Max-Age</code>减少OPTIONS请求</li><li><strong>防御CSRF攻击</strong>：配合SameSite Cookie、CSRF Token等机制</li></ol><h2 id="八、常见问题排查" tabindex="-1">八、常见问题排查 <a class="header-anchor" href="#八、常见问题排查" aria-label="Permalink to &quot;八、常见问题排查&quot;">​</a></h2><h3 id="_8-1-典型错误场景" tabindex="-1">8.1 典型错误场景 <a class="header-anchor" href="#_8-1-典型错误场景" aria-label="Permalink to &quot;8.1 典型错误场景&quot;">​</a></h3><table tabindex="0"><thead><tr><th><strong>错误现象</strong></th><th><strong>原因分析</strong></th><th><strong>解决方案</strong></th></tr></thead><tbody><tr><td>预检请求失败</td><td>服务器未处理OPTIONS方法</td><td>配置路由响应OPTIONS</td></tr><tr><td>凭证未发送</td><td>客户端未设<code>withCredentials</code></td><td>检查前端配置</td></tr><tr><td><code>Access-Control-Allow-Origin</code>无效</td><td>服务端响应头缺失或值不匹配</td><td>检查请求Origin与响应头</td></tr><tr><td>自定义头被拦截</td><td>未在<code>Allow-Headers</code>中声明</td><td>添加对应Header到白名单</td></tr></tbody></table><h3 id="_8-2-调试工具使用" tabindex="-1">8.2 调试工具使用 <a class="header-anchor" href="#_8-2-调试工具使用" aria-label="Permalink to &quot;8.2 调试工具使用&quot;">​</a></h3><ol><li><strong>浏览器开发者工具</strong>： <ul><li>Network标签查看<code>Origin</code>和<code>Access-Control-*</code>头</li><li>控制台识别CORS错误代码（如<code>No &#39;Access-Control-Allow-Origin&#39;</code>）</li></ul></li><li><strong>CURL验证</strong>：<div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 模拟预检请求</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> OPTIONS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Origin: http://your-site.com&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Access-Control-Request-Method: DELETE&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -I</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://api.target.com/resource</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ol><h2 id="九、cors替代方案对比" tabindex="-1">九、CORS替代方案对比 <a class="header-anchor" href="#九、cors替代方案对比" aria-label="Permalink to &quot;九、CORS替代方案对比&quot;">​</a></h2><table tabindex="0"><thead><tr><th><strong>方案</strong></th><th><strong>原理</strong></th><th><strong>适用场景</strong></th><th><strong>局限性</strong></th></tr></thead><tbody><tr><td><strong>JSONP</strong></td><td>动态创建<code>&lt;script&gt;</code>标签</td><td>仅GET请求</td><td>安全性差，不支持POST</td></tr><tr><td><strong>代理服务器</strong></td><td>同源服务器中转请求</td><td>老旧浏览器兼容</td><td>增加服务器负担</td></tr><tr><td><strong>WebSocket</strong></td><td>双向通信协议</td><td>实时应用</td><td>协议升级复杂</td></tr><tr><td><strong>postMessage</strong></td><td>iframe间通信</td><td>跨窗口消息传递</td><td>无法直接请求API</td></tr></tbody></table><blockquote><p><strong>最佳实践建议</strong>：现代Web应用首选CORS，JSONP仅作兼容备用方案</p></blockquote><h2 id="十、扩展应用场景" tabindex="-1">十、扩展应用场景 <a class="header-anchor" href="#十、扩展应用场景" aria-label="Permalink to &quot;十、扩展应用场景&quot;">​</a></h2><ol><li><strong>跨域资源类型</strong>： <ul><li>Web字体（<code>@font-face</code>）</li><li>WebGL纹理</li><li>Canvas的<code>drawImage()</code></li></ul></li><li><strong>服务端渲染（SSR）</strong>：需配置API服务的CORS支持前端直连</li><li><strong>微前端架构</strong>：子应用间跨域通信</li><li><strong>第三方API集成</strong>：如支付网关、地图服务等</li></ol><blockquote><p>通过合理配置CORS策略，可在保障安全性的同时实现灵活的资源共享，为现代Web应用提供跨域解决方案。</p></blockquote>`,45))])}const C=e(k,[["render",c]]);export{A as __pageData,C as default};
